---
title: "Preparation of data on Bacteria Levels at Casco Bay Beaches"
author: "Curtis C. Bohlen, Casco Bay Estuary Partnership."
date: "01/23/2021"
output:
  github_document:
    toc: true
    fig_width: 5
    fig_height: 4
---
<img
    src="https://www.cascobayestuary.org/wp-content/uploads/2014/04/logo_sm.jpg"
    style="position:absolute;top:10px;right:50px;" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = 'center',
                      fig.width = 5, fig.height = 4,
                      collapse = TRUE, comment = "#>")
```

# Introduction
# Import Libraries  
```{r import_libraries}
library(tidyverse)
library(readxl)
#library(emmeans) # Provides tools for calculating marginal means

#library(nlme)    # Provides GLS model functions -- not used here

#library(mgcv)    # generalized additive models. Function gamm() allows
                 # autocorrelated errors.

library(CBEPgraphics)
load_cbep_fonts()
theme_set(theme_cbep())

```

# Data Preparation
## Initial Folder References
```{r folders}
sibfldnm    <- 'Original_Data'
parent      <- dirname(getwd())
sibling     <- file.path(parent,sibfldnm)

#dir.create(file.path(getwd(), 'figures'), showWarnings = FALSE)
#dir.create(file.path(getwd(), 'models'), showWarnings = FALSE)
```

## Load Data
```{r}
fn <- "CascoBay_StateOfTheBay_DataRequest 04152020.xlsx"

raw_data <- read_excel(file.path(sibling, fn), 
                       sheet = "Data",
                       #range = cell_rows(1:1000),  # used to test col_types
                       col_types = c("text", "skip", "date", "text", 
                                   "skip", "skip", "text", "numeric",    #h
                                   "text", "text", "numeric", "text", 
                                   "skip", "skip", "skip", "skip",       #p
                                   "skip", "skip", "text", "skip", 
                                   "numeric", "skip", "numeric", "skip", #x
                                   "skip",  "skip",                      #z
                                   "skip", "skip", 
                                   "skip", "skip", "skip", "text", 
                                   "text"),
                       .name_repair = 'universal')
```

```{r}
names(raw_data)
```


```{r}
levels(factor(raw_data$Reporting.Limit))
```


```{r}
raw_data <- raw_data %>%
  rename(SiteCode = Sample.Point.Name,
         sdate = Sample.Date,
         Parameter = CAS.Name,
         Units = Parameter.Unit
         
         )
```


# Tracking Left Censored Data
It is a  bit unclear which observations are left censored.

The enterococci data is sometimes blank,  with a "Lab Qualifier" = "U".  These
appear to be conventional "non-detects".  There are also a fairly high number 
of samples, where the reported concentration equals the reporting limit.  That 
reporting limit is either 1 or 10, and corresponds to the Dilution Factor.

```{r}
raw_data %>%
  filter(Parameter == 'ENTEROCOCCI') %>%
ggplot(aes(Concentration)) +
  geom_histogram() +
  scale_x_log10()
```

From that, you can see the high number of sample at the nominal reporting 
limit. Given the distribution, it is not unreasonable to think these may
reflect pooled values from "nearby" values, as the MPN method does not provide
actual quantitation of number of colony forming units, but average numbers given
the response to the method, based on serial dilutions.

```{r}
raw_data %>%
  filter(Parameter == 'ENTEROCOCCI') %>%
  group_by(Lab.Qualifier) %>%
  summarize(missing = sum(is.na(Concentration)),
            not_missing = sum(! is.na(Concentration))
            )
```

```{r}
raw_data %>%
  mutate(year = as.numeric(format(sdate, format = '%Y'))) %>% 
  filter(Parameter == 'ENTEROCOCCI') %>%
  filter(Concentration == 10) %>%
  select(Concentration, year) %>%
  ggplot(aes(x = year)) + 
  geom_bar()
```

So those samples with nominal value of 10  occur throughout the record, and are
unlikely to be censored values coded differently during a certain period of
time.
